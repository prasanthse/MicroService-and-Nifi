/*!
 * jquery.event.drag - v 2.2
 * Copyright (c) 2010 Three Dub Media - http://threedubmedia.com
 * Open Source MIT License - http://threedubmedia.com/code/license
 */
(function(j){j.fn.drag=function(a,e,b){var c=typeof a=="string"?a:"",d=j.isFunction(a)?a:j.isFunction(e)?e:null;if(c.indexOf("drag")!==0){c="drag"+c}b=(a==d?e:b)||{};return d?this.bind(c,b,d):this.trigger(c)};var g=j.event,h=g.special,k=h.drag={defaults:{which:1,distance:0,not:":input",handle:null,relative:false,drop:true,click:false},datakey:"dragdata",noBubble:true,add:function(a){var b=j.data(this,k.datakey),c=a.data||{};b.related+=1;j.each(k.defaults,function(e,d){if(c[e]!==undefined){b[e]=c[e]}})},remove:function(){j.data(this,k.datakey).related-=1},setup:function(){if(j.data(this,k.datakey)){return}var a=j.extend({related:0},k.defaults);j.data(this,k.datakey,a);g.add(this,"touchstart mousedown",k.init,a);if(this.attachEvent){this.attachEvent("ondragstart",k.dontstart)}},teardown:function(){var a=j.data(this,k.datakey)||{};if(a.related){return}j.removeData(this,k.datakey);g.remove(this,"touchstart mousedown",k.init);k.textselect(true);if(this.detachEvent){this.detachEvent("ondragstart",k.dontstart)}},init:function(a){if(k.touched){return}var c=a.data,b;if(a.which!=0&&c.which>0&&a.which!=c.which){return}if(j(a.target).is(c.not)){return}if(c.handle&&!j(a.target).closest(c.handle,a.currentTarget).length){return}k.touched=a.type=="touchstart"?this:null;c.propagates=1;c.mousedown=this;c.interactions=[k.interaction(this,c)];c.target=a.target;c.pageX=a.pageX;c.pageY=a.pageY;c.dragging=null;b=k.hijack(a,"draginit",c);if(!c.propagates){return}b=k.flatten(b);if(b&&b.length){c.interactions=[];j.each(b,function(){c.interactions.push(k.interaction(this,c))})}c.propagates=c.interactions.length;if(c.drop!==false&&h.drop){h.drop.handler(a,c)}k.textselect(false);if(k.touched){g.add(k.touched,"touchmove touchend",k.handler,c)}else{g.add(document,"mousemove mouseup",k.handler,c)}if(!k.touched||c.live){return false}},interaction:function(b,c){var a=j(b)[c.relative?"position":"offset"]()||{top:0,left:0};return{drag:b,callback:new k.callback(),droppable:[],offset:a}},handler:function(a){var b=a.data;switch(a.type){case !b.dragging&&"touchmove":a.preventDefault();case !b.dragging&&"mousemove":if(Math.pow(a.pageX-b.pageX,2)+Math.pow(a.pageY-b.pageY,2)<Math.pow(b.distance,2)){break}a.target=b.target;k.hijack(a,"dragstart",b);if(b.propagates){b.dragging=true}case"touchmove":a.preventDefault();case"mousemove":if(b.dragging){k.hijack(a,"drag",b);if(b.propagates){if(b.drop!==false&&h.drop){h.drop.handler(a,b)}break}a.type="mouseup"}case"touchend":case"mouseup":default:if(k.touched){g.remove(k.touched,"touchmove touchend",k.handler)}else{g.remove(document,"mousemove mouseup",k.handler)}if(b.dragging){if(b.drop!==false&&h.drop){h.drop.handler(a,b)}k.hijack(a,"dragend",b)}k.textselect(true);if(b.click===false&&b.dragging){j.data(b.mousedown,"suppress.click",new Date().getTime()+5)}b.dragging=k.touched=false;break}},hijack:function(x,d,a,c,v){if(!a){return}var b={event:x.originalEvent,type:x.type},f=d.indexOf("drop")?"drag":"drop",z,u=c||0,w,y,A,e=!isNaN(c)?c:a.interactions.length;x.type=d;x.originalEvent=null;a.results=[];do{if(w=a.interactions[u]){if(d!=="dragend"&&w.cancelled){continue}A=k.properties(x,a,w);w.results=[];j(v||w[f]||a.droppable).each(function(m,n){A.target=n;x.isPropagationStopped=function(){return false};z=n?g.dispatch.call(n,x,A):null;if(z===false){if(f=="drag"){w.cancelled=true;a.propagates-=1}if(d=="drop"){w[f][m]=null}}else{if(d=="dropinit"){w.droppable.push(k.element(z)||n)}}if(d=="dragstart"){w.proxy=j(k.element(z)||w.drag)[0]}w.results.push(z);delete x.result;if(d!=="dropinit"){return z}});a.results[u]=k.flatten(w.results);if(d=="dropinit"){w.droppable=k.flatten(w.droppable)}if(d=="dragstart"&&!w.cancelled){A.update()}}}while(++u<e);x.type=b.type;x.originalEvent=b.event;return k.flatten(a.results)},properties:function(b,d,c){var a=c.callback;a.drag=c.drag;a.proxy=c.proxy||c.drag;a.startX=d.pageX;a.startY=d.pageY;a.deltaX=b.pageX-d.pageX;a.deltaY=b.pageY-d.pageY;a.originalX=c.offset.left;a.originalY=c.offset.top;a.offsetX=a.originalX+a.deltaX;a.offsetY=a.originalY+a.deltaY;a.drop=k.flatten((c.drop||[]).slice());a.available=k.flatten((c.droppable||[]).slice());return a},element:function(a){if(a&&(a.jquery||a.nodeType==1)){return a}},flatten:function(a){return j.map(a,function(b){return b&&b.jquery?j.makeArray(b):b&&b.length?k.flatten(b):b})},textselect:function(a){j(document)[a?"unbind":"bind"]("selectstart",k.dontstart).css("MozUserSelect",a?"":"none");document.unselectable=a?"off":"on"},dontstart:function(){return false},callback:function(){}};k.callback.prototype={update:function(){if(h.drop&&this.available.length){j.each(this.available,function(a){h.drop.locate(this,a)})}}};var i=g.dispatch;g.dispatch=function(a){if(j.data(this,"suppress."+a.type)-new Date().getTime()>0){j.removeData(this,"suppress."+a.type);return}return i.apply(this,arguments)};var l=g.fixHooks.touchstart=g.fixHooks.touchmove=g.fixHooks.touchend=g.fixHooks.touchcancel={props:"clientX clientY pageX pageY screenX screenY".split(" "),filter:function(b,a){if(a){var c=(a.touches&&a.touches[0])||(a.changedTouches&&a.changedTouches[0])||null;if(c){j.each(l.props,function(e,d){b[d]=c[d]})}}return b}};h.draginit=h.dragstart=h.dragend=k})(jQuery);